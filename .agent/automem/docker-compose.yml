# AutoMem for Coolify - AI Agent Memory System
# Deploy via Coolify as Docker Compose
# Использует Voyage AI для embeddings (200M токенов бесплатно)

services:
  # ═══════════════════════════════════════════════════════════════
  # AutoMem API - Основной сервис памяти
  # ═══════════════════════════════════════════════════════════════
  automem:
    # Build directly from public GitHub repo to avoid GHCR auth errors
    build: https://github.com/verygoodplugins/automem.git#main
    ports:
      - "8001:8001"
    environment:
      PORT: 8001

      # === Аутентификация ===
      AUTOMEM_API_TOKEN: ${AUTOMEM_API_TOKEN}
      ADMIN_API_TOKEN: ${ADMIN_API_TOKEN}

      # === FalkorDB (Graph Database) ===
      FALKORDB_HOST: falkordb
      FALKORDB_PORT: 6379
      FALKORDB_PASSWORD: ${FALKORDB_PASSWORD:-}
      FALKORDB_GRAPH: agent_memories

      # === Qdrant (Vector Database) ===
      QDRANT_URL: http://qdrant:6333
      QDRANT_COLLECTION: agent_memories

      # === Voyage AI Embeddings (ЛУЧШАЯ модель) ===
      # voyage-3-large: 1024 dimensions, лучшее качество
      OPENAI_API_KEY: ${VOYAGE_API_KEY}
      OPENAI_API_BASE: https://api.voyageai.com/v1
      EMBEDDING_MODEL: voyage-3-large
      VECTOR_SIZE: 1024

      # === Enrichment Settings ===
      ENRICHMENT_ENABLE_SUMMARIES: "true"
      ENRICHMENT_SIMILARITY_THRESHOLD: "0.75"
      ENRICHMENT_SIMILARITY_LIMIT: "10"

      # === Consolidation ===
      CONSOLIDATION_DECAY_INTERVAL_SECONDS: "7200"
      CONSOLIDATION_CLUSTER_INTERVAL_SECONDS: "21600"

    depends_on:
      falkordb:
        condition: service_healthy
      qdrant:
        condition: service_started
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8001/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ═══════════════════════════════════════════════════════════════
  # FalkorDB - Graph Database для связей между воспоминаниями
  # ═══════════════════════════════════════════════════════════════
  falkordb:
    image: falkordb/falkordb:latest
    ports:
      - "6379:6379"
    volumes:
      - falkordb_data:/data
    environment:
      REDIS_ARGS: "--save 60 1 --appendonly yes --appendfsync everysec --dir /data"
      REDIS_PASSWORD: ${FALKORDB_PASSWORD:-}
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ═══════════════════════════════════════════════════════════════
  # Qdrant - Vector Database для semantic search
  # ═══════════════════════════════════════════════════════════════
  qdrant:
    image: qdrant/qdrant:v1.11.3
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      QDRANT__SERVICE__GRPC_PORT: "6334"
    restart: unless-stopped

  # ═══════════════════════════════════════════════════════════════
  # FalkorDB Browser - UI для визуализации графа (опционально)
  # ═══════════════════════════════════════════════════════════════
  falkordb-browser:
    image: falkordb/falkordb-browser:latest
    ports:
      - "3001:3000"
    environment:
      FALKORDB_URL: redis://${FALKORDB_PASSWORD:+:${FALKORDB_PASSWORD}@}falkordb:6379
    depends_on:
      - falkordb
    restart: unless-stopped
    profiles: [ "browser" ] # docker-compose --profile browser up

volumes:
  falkordb_data:
    driver: local
  qdrant_data:
    driver: local
